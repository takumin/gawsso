name: CI
on:
  push:
    branches:
    - 'main'
  pull_request:
    paths:
    # Build
    - 'Makefile'
    - '.aqua.yaml'
    # GoReleaser
    - '.goreleaser.yml'
    # GitHub Actions
    - '.github/actions/setup-go/action.yaml'
    - '.github/actions/setup-aqua/action.yaml'
    - '.github/actions/setup-reviewdog/action.yaml'
    - '.github/dependency/actions-cache-version'
    - '.github/workflows/integration.yml'
    # Go
    - '**.go'
    - 'go.mod'
    - 'go.sum'
permissions:
  contents: read
jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
    ################################################################################
    # Checkout
    ################################################################################
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: ${{ startsWith(github.ref, 'refs/tags/') && '0' || '1' }}
    ################################################################################
    # Setup
    ################################################################################
    - name: Setup Go
      uses: ./.github/actions/setup-go
    - name: Setup Aqua
      uses: ./.github/actions/setup-aqua
    - name: Setup Reviewdog
      id: reviewdog
      uses: ./.github/actions/setup-reviewdog
    ################################################################################
    # Reviewdog
    ################################################################################
    - name: Reviewdog (gofmt)
      if: ${{ steps.reviewdog.outputs.running == 'true' }}
      run: reviewdog -runners 'gofmt' -reporter '${{ steps.reviewdog.outputs.reporter }}' -diff 'git diff FETCH_HEAD'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Reviewdog (govet)
      if: ${{ steps.reviewdog.outputs.running == 'true' }}
      run: reviewdog -runners 'govet' -reporter '${{ steps.reviewdog.outputs.reporter }}' -diff 'git diff FETCH_HEAD'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Reviewdog (gosec)
      if: ${{ steps.reviewdog.outputs.running == 'true' }}
      run: reviewdog -runners 'gosec' -reporter '${{ steps.reviewdog.outputs.reporter }}' -diff 'git diff FETCH_HEAD'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Reviewdog (staticcheck)
      if: ${{ steps.reviewdog.outputs.running == 'true' }}
      run: reviewdog -runners 'staticcheck' -reporter '${{ steps.reviewdog.outputs.reporter }}' -diff 'git diff FETCH_HEAD'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    ################################################################################
    # Go
    ################################################################################
    - name: Go Mod Download
      run: go mod download
    - name: Go Mod Tidy
      run: go mod tidy
    - name: Go Generate
      run: make generate
    - name: Go Test
      run: make test
    - name: Go Build
      run: make build
    ################################################################################
    # Release
    ################################################################################
    - name: ${{ (startsWith(github.ref, 'refs/tags/') && 'Release') || 'Snapshot' }}
      run: make ${{ (startsWith(github.ref, 'refs/tags/') && 'release') || 'snapshot' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    ################################################################################
    # Artifact
    ################################################################################
    - name: Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Artifacts
        path: |
          dist/*.tar.gz
          dist/*.zip
          dist/*.txt
